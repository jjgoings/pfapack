<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PFAPACK Benchmarks with Error Bars</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-error-bars@3"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .chart-container { width: 100%; max-width: 900px; margin: 20px 0; }
        .platform-section { margin-bottom: 40px; }
    </style>
</head>
<body>
    <h1>PFAPACK Performance Benchmarks (with 95% CI)</h1>
    <div id="charts"></div>
    
    <script>
    async function loadData(platform) {
        const script = document.createElement('script');
        script.src = `${platform}/data.js`;
        document.head.appendChild(script);
        await new Promise(r => setTimeout(r, 500));
        return window.BENCHMARK_DATA;
    }
    
    function processData(data) {
        const entries = Object.values(data.entries)[0];
        const benchmarks = {};
        
        entries.forEach(entry => {
            const commit = entry.commit.id.slice(0, 7);
            entry.benches.forEach(bench => {
                if (!benchmarks[bench.name]) benchmarks[bench.name] = [];
                
                // Parse range like "± 0.000413"
                let stddev = 0;
                if (bench.range) {
                    const match = bench.range.match(/±?\s*([\d.]+)/);
                    if (match) stddev = parseFloat(match[1]);
                }
                
                // 95% CI = 1.96 * stddev
                const ci95 = 1.96 * stddev;
                
                benchmarks[bench.name].push({
                    commit,
                    value: bench.value,
                    yMin: bench.value - ci95,
                    yMax: bench.value + ci95
                });
            });
        });
        return benchmarks;
    }
    
    function createChart(container, name, data) {
        const div = document.createElement('div');
        div.className = 'chart-container';
        const canvas = document.createElement('canvas');
        div.appendChild(canvas);
        container.appendChild(div);
        
        new Chart(canvas, {
            type: 'lineWithErrorBars',
            data: {
                labels: data.map(d => d.commit),
                datasets: [{
                    label: name,
                    data: data.map(d => ({
                        y: d.value,
                        yMin: d.yMin,
                        yMax: d.yMax
                    })),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    errorBarColor: '#c0392b',
                    errorBarWhiskerColor: '#c0392b',
                    errorBarWhiskerSize: 5,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: name },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const d = data[ctx.dataIndex];
                                return `${(d.value*1000).toFixed(3)} ms ± ${((d.yMax-d.value)*1000).toFixed(3)} ms (95% CI)`;
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'commit' } },
                    y: { title: { display: true, text: 'time (s)' }, beginAtZero: true }
                }
            }
        });
    }
    
    async function main() {
        const container = document.getElementById('charts');
        
        for (const platform of ['ubuntu-latest', 'macos-latest']) {
            const section = document.createElement('div');
            section.className = 'platform-section';
            section.innerHTML = `<h2>${platform}</h2>`;
            container.appendChild(section);
            
            try {
                const data = await loadData(platform);
                const benchmarks = processData(data);
                
                for (const [name, benchData] of Object.entries(benchmarks)) {
                    createChart(section, name, benchData);
                }
            } catch (e) {
                section.innerHTML += `<p>Error loading ${platform}: ${e}</p>`;
            }
            
            window.BENCHMARK_DATA = null;
        }
    }
    
    main();
    </script>
</body>
</html>
