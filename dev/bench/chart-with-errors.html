<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PFAPACK Benchmarks with Error Bars</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-error-bars@3"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: #fafafa; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        .chart-container { width: 100%; max-width: 900px; margin: 20px 0; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .platform-section { margin-bottom: 40px; }
    </style>
</head>
<body>
    <h1>PFAPACK Performance Benchmarks (with 95% CI)</h1>
    <p>Hover over points to see commit message and timing details.</p>
    <div id="charts"></div>
    
    <script>
    async function loadData(platform) {
        const script = document.createElement('script');
        script.src = `${platform}/data.js`;
        document.head.appendChild(script);
        await new Promise(r => setTimeout(r, 500));
        return window.BENCHMARK_DATA;
    }
    
    function processData(data) {
        const entries = Object.values(data.entries)[0];
        const benchmarks = {};
        
        entries.forEach(entry => {
            const commit = entry.commit.id.slice(0, 7);
            const message = entry.commit.message.split('\n')[0].slice(0, 60);
            
            entry.benches.forEach(bench => {
                if (!benchmarks[bench.name]) benchmarks[bench.name] = [];
                
                let stddev = 0;
                if (bench.range) {
                    const match = bench.range.match(/±?\s*([\d.eE+-]+)/);
                    if (match) stddev = parseFloat(match[1]);
                }
                
                const ci95 = 1.96 * stddev;
                
                benchmarks[bench.name].push({
                    commit,
                    message,
                    value: bench.value,
                    stddev,
                    yMin: Math.max(0, bench.value - ci95),
                    yMax: bench.value + ci95
                });
            });
        });
        return benchmarks;
    }
    
    function createChart(container, name, data) {
        const div = document.createElement('div');
        div.className = 'chart-container';
        const canvas = document.createElement('canvas');
        div.appendChild(canvas);
        container.appendChild(div);
        
        new Chart(canvas, {
            type: 'lineWithErrorBars',
            data: {
                labels: data.map(d => d.commit),
                datasets: [{
                    label: name,
                    data: data.map(d => ({
                        y: d.value,
                        yMin: d.yMin,
                        yMax: d.yMax
                    })),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    errorBarColor: '#c0392b',
                    errorBarWhiskerColor: '#c0392b',
                    errorBarWhiskerSize: 5,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    title: { display: true, text: name, font: { size: 16 } },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        padding: 12,
                        callbacks: {
                            title: (ctx) => {
                                const d = data[ctx[0].dataIndex];
                                return `${d.commit}: ${d.message}`;
                            },
                            label: (ctx) => {
                                const d = data[ctx.dataIndex];
                                const ms = d.value * 1000;
                                const ci = (d.yMax - d.value) * 1000;
                                if (ms > 1) {
                                    return `${ms.toFixed(2)} ms ± ${ci.toFixed(2)} ms (95% CI)`;
                                } else {
                                    return `${(ms*1000).toFixed(1)} µs ± ${(ci*1000).toFixed(1)} µs (95% CI)`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'commit' },
                        ticks: { maxRotation: 45 }
                    },
                    y: { 
                        title: { display: true, text: 'time (s)' }, 
                        beginAtZero: true 
                    }
                }
            }
        });
    }
    
    async function main() {
        const container = document.getElementById('charts');
        
        for (const platform of ['ubuntu-latest', 'macos-latest']) {
            const section = document.createElement('div');
            section.className = 'platform-section';
            section.innerHTML = `<h2>${platform}</h2>`;
            container.appendChild(section);
            
            try {
                const data = await loadData(platform);
                const benchmarks = processData(data);
                
                for (const [name, benchData] of Object.entries(benchmarks)) {
                    createChart(section, name, benchData);
                }
            } catch (e) {
                section.innerHTML += `<p>Error loading ${platform}: ${e}</p>`;
            }
            
            window.BENCHMARK_DATA = null;
        }
    }
    
    main();
    </script>
</body>
</html>
